name: Test Docker Image

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to test'
        required: false
        default: 'latest'
  workflow_call:
    inputs:
      image_tag:
        description: 'Docker image tag to test'
        required: false
        default: 'latest'
        type: string

env:
  DOCKER_IMAGE: ops4life/terraform-toolkit

jobs:
  test-versions:
    name: Test Tool Versions
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Prepare Platform Name
        run: |
          platform=${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV

      - name: Determine Image Tag and Load Method
        id: image
        run: |
          IMAGE_TAG="${{ inputs.image_tag }}"

          # If no tag provided, default to latest
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG="latest"
          fi

          # Extract architecture suffix from platform (linux/amd64 -> amd64)
          ARCH=$(echo "${{ matrix.platform }}" | cut -d'/' -f2)

          # If tag is pr-test, load from artifact
          if [ "$IMAGE_TAG" = "pr-test" ]; then
            echo "tag=pr-test-${ARCH}" >> $GITHUB_OUTPUT
            echo "load_from_artifact=true" >> $GITHUB_OUTPUT
          else
            echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
            echo "load_from_artifact=false" >> $GITHUB_OUTPUT
          fi

      - name: Download Docker image artifact
        if: steps.image.outputs.load_from_artifact == 'true'
        uses: actions/download-artifact@v7
        with:
          name: docker-image-${{ steps.image.outputs.tag == 'pr-test-amd64' && 'amd64' || 'arm64' }}
          path: /tmp

      - name: Load Docker image from artifact
        if: steps.image.outputs.load_from_artifact == 'true'
        run: |
          gunzip -c /tmp/image-*.tar.gz | docker load

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull Docker Image from registry
        if: steps.image.outputs.load_from_artifact == 'false'
        run: docker pull --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }}

      - name: Test Terraform Version
        run: |
          docker run --rm --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} terraform version

      - name: Test Terragrunt Version
        run: |
          docker run --rm --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} terragrunt --version

      - name: Test Checkov Version
        run: |
          docker run --rm --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} checkov --version

      - name: Test TFLint Version
        run: |
          docker run --rm --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} tflint --version

      - name: Test Trivy Version
        run: |
          docker run --rm --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} trivy --version

      - name: Test terraform-docs Version
        run: |
          docker run --rm --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} terraform-docs --version

      - name: Test eksctl Version
        run: |
          docker run --rm --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} eksctl version

      - name: Test AWS CLI Version
        run: |
          docker run --rm --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} aws --version

      - name: Test pre-commit Version
        run: |
          docker run --rm --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} pre-commit --version

  test-terraform-workflow:
    name: Test Terraform Workflow
    runs-on: ubuntu-24.04
    needs: test-versions
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Prepare Platform Name
        run: |
          platform=${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV

      - name: Determine Image Tag and Load Method
        id: image
        run: |
          IMAGE_TAG="${{ inputs.image_tag }}"

          # If no tag provided, default to latest
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG="latest"
          fi

          # Extract architecture suffix from platform (linux/amd64 -> amd64)
          ARCH=$(echo "${{ matrix.platform }}" | cut -d'/' -f2)

          # If tag is pr-test, load from artifact
          if [ "$IMAGE_TAG" = "pr-test" ]; then
            echo "tag=pr-test-${ARCH}" >> $GITHUB_OUTPUT
            echo "load_from_artifact=true" >> $GITHUB_OUTPUT
          else
            echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
            echo "load_from_artifact=false" >> $GITHUB_OUTPUT
          fi

      - name: Download Docker image artifact
        if: steps.image.outputs.load_from_artifact == 'true'
        uses: actions/download-artifact@v7
        with:
          name: docker-image-${{ steps.image.outputs.tag == 'pr-test-amd64' && 'amd64' || 'arm64' }}
          path: /tmp

      - name: Load Docker image from artifact
        if: steps.image.outputs.load_from_artifact == 'true'
        run: |
          gunzip -c /tmp/image-*.tar.gz | docker load

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.image.outputs.load_from_artifact == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Pull Docker Image from registry
        if: steps.image.outputs.load_from_artifact == 'false'
        run: docker pull --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }}

      - name: Create Output Directory
        run: mkdir -p test/output

      - name: Terraform Init
        working-directory: test
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            --user $(id -u):$(id -g) \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} \
            terraform init

      - name: Terraform Validate
        working-directory: test
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            --user $(id -u):$(id -g) \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} \
            terraform validate

      - name: Terraform Format Check
        working-directory: test
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            --user $(id -u):$(id -g) \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} \
            terraform fmt -check -recursive

      - name: Terraform Plan
        working-directory: test
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            --user $(id -u):$(id -g) \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} \
            terraform plan -out=tfplan -json | tee terraform-plan-${{ env.PLATFORM_PAIR }}.json

      - name: Upload Terraform Plan Artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: terraform-plan-${{ env.PLATFORM_PAIR }}
          path: test/terraform-plan-${{ env.PLATFORM_PAIR }}.json
          retention-days: 7

  test-linting:
    name: Test Linting Tools
    runs-on: ubuntu-24.04
    needs: test-versions
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Prepare Platform Name
        run: |
          platform=${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV

      - name: Determine Image Tag and Load Method
        id: image
        run: |
          IMAGE_TAG="${{ inputs.image_tag }}"

          # If no tag provided, default to latest
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG="latest"
          fi

          # Extract architecture suffix from platform (linux/amd64 -> amd64)
          ARCH=$(echo "${{ matrix.platform }}" | cut -d'/' -f2)

          # If tag is pr-test, load from artifact
          if [ "$IMAGE_TAG" = "pr-test" ]; then
            echo "tag=pr-test-${ARCH}" >> $GITHUB_OUTPUT
            echo "load_from_artifact=true" >> $GITHUB_OUTPUT
          else
            echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
            echo "load_from_artifact=false" >> $GITHUB_OUTPUT
          fi

      - name: Download Docker image artifact
        if: steps.image.outputs.load_from_artifact == 'true'
        uses: actions/download-artifact@v7
        with:
          name: docker-image-${{ steps.image.outputs.tag == 'pr-test-amd64' && 'amd64' || 'arm64' }}
          path: /tmp

      - name: Load Docker image from artifact
        if: steps.image.outputs.load_from_artifact == 'true'
        run: |
          gunzip -c /tmp/image-*.tar.gz | docker load

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.image.outputs.load_from_artifact == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Pull Docker Image from registry
        if: steps.image.outputs.load_from_artifact == 'false'
        run: docker pull --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }}

      - name: Terraform Init (for TFLint)
        working-directory: test
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            --user $(id -u):$(id -g) \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} \
            terraform init

      - name: TFLint Init
        working-directory: test
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            --user $(id -u):$(id -g) \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} \
            tflint --init

      - name: Run TFLint
        working-directory: test
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            --user $(id -u):$(id -g) \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} \
            tflint --format=json | tee tflint-${{ env.PLATFORM_PAIR }}.json

      - name: Upload TFLint Results Artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: tflint-results-${{ env.PLATFORM_PAIR }}
          path: test/tflint-${{ env.PLATFORM_PAIR }}.json
          retention-days: 7

  test-security:
    name: Test Security Scanning
    runs-on: ubuntu-24.04
    needs: test-versions
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Prepare Platform Name
        run: |
          platform=${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV

      - name: Determine Image Tag and Load Method
        id: image
        run: |
          IMAGE_TAG="${{ inputs.image_tag }}"

          # If no tag provided, default to latest
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG="latest"
          fi

          # Extract architecture suffix from platform (linux/amd64 -> amd64)
          ARCH=$(echo "${{ matrix.platform }}" | cut -d'/' -f2)

          # If tag is pr-test, load from artifact
          if [ "$IMAGE_TAG" = "pr-test" ]; then
            echo "tag=pr-test-${ARCH}" >> $GITHUB_OUTPUT
            echo "load_from_artifact=true" >> $GITHUB_OUTPUT
          else
            echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
            echo "load_from_artifact=false" >> $GITHUB_OUTPUT
          fi

      - name: Download Docker image artifact
        if: steps.image.outputs.load_from_artifact == 'true'
        uses: actions/download-artifact@v7
        with:
          name: docker-image-${{ steps.image.outputs.tag == 'pr-test-amd64' && 'amd64' || 'arm64' }}
          path: /tmp

      - name: Load Docker image from artifact
        if: steps.image.outputs.load_from_artifact == 'true'
        run: |
          gunzip -c /tmp/image-*.tar.gz | docker load

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.image.outputs.load_from_artifact == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Pull Docker Image from registry
        if: steps.image.outputs.load_from_artifact == 'false'
        run: docker pull --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }}

      - name: Run Checkov
        working-directory: test
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            --user $(id -u):$(id -g) \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} \
            checkov -d . --output=json | tee checkov-${{ env.PLATFORM_PAIR }}.json || true

      - name: Run Trivy Filesystem Scan
        working-directory: test
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            --user $(id -u):$(id -g) \
            -v $(pwd):/workspace \
            -e TRIVY_CACHE_DIR=/workspace/.trivy-cache \
            -w /workspace \
            ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} \
            trivy fs . --exit-code 0 --format=json | tee trivy-${{ env.PLATFORM_PAIR }}.json

      - name: Upload Security Scan Artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: security-scan-results-${{ env.PLATFORM_PAIR }}
          path: |
            test/checkov-${{ env.PLATFORM_PAIR }}.json
            test/trivy-${{ env.PLATFORM_PAIR }}.json
          retention-days: 7

  test-documentation:
    name: Test Documentation Generation
    runs-on: ubuntu-24.04
    needs: test-versions
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Prepare Platform Name
        run: |
          platform=${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV

      - name: Determine Image Tag and Load Method
        id: image
        run: |
          IMAGE_TAG="${{ inputs.image_tag }}"

          # If no tag provided, default to latest
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG="latest"
          fi

          # Extract architecture suffix from platform (linux/amd64 -> amd64)
          ARCH=$(echo "${{ matrix.platform }}" | cut -d'/' -f2)

          # If tag is pr-test, load from artifact
          if [ "$IMAGE_TAG" = "pr-test" ]; then
            echo "tag=pr-test-${ARCH}" >> $GITHUB_OUTPUT
            echo "load_from_artifact=true" >> $GITHUB_OUTPUT
          else
            echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
            echo "load_from_artifact=false" >> $GITHUB_OUTPUT
          fi

      - name: Download Docker image artifact
        if: steps.image.outputs.load_from_artifact == 'true'
        uses: actions/download-artifact@v7
        with:
          name: docker-image-${{ steps.image.outputs.tag == 'pr-test-amd64' && 'amd64' || 'arm64' }}
          path: /tmp

      - name: Load Docker image from artifact
        if: steps.image.outputs.load_from_artifact == 'true'
        run: |
          gunzip -c /tmp/image-*.tar.gz | docker load

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.image.outputs.load_from_artifact == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Pull Docker Image from registry
        if: steps.image.outputs.load_from_artifact == 'false'
        run: docker pull --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }}

      - name: Generate terraform-docs
        working-directory: test
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            --user $(id -u):$(id -g) \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} \
            terraform-docs markdown table . > DOCS_OUTPUT.md

      - name: Verify Documentation Generated
        working-directory: test
        run: |
          if [ ! -s DOCS_OUTPUT.md ]; then
            echo "Error: Documentation was not generated"
            exit 1
          fi
          echo "Documentation generated successfully"
          head -20 DOCS_OUTPUT.md

      - name: Upload terraform-docs Artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: terraform-docs-${{ env.PLATFORM_PAIR }}
          path: test/DOCS_OUTPUT.md
          retention-days: 7

  test-terragrunt:
    name: Test Terragrunt
    runs-on: ubuntu-24.04
    needs: test-versions
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Prepare Platform Name
        run: |
          platform=${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV

      - name: Determine Image Tag and Load Method
        id: image
        run: |
          IMAGE_TAG="${{ inputs.image_tag }}"

          # If no tag provided, default to latest
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG="latest"
          fi

          # Extract architecture suffix from platform (linux/amd64 -> amd64)
          ARCH=$(echo "${{ matrix.platform }}" | cut -d'/' -f2)

          # If tag is pr-test, load from artifact
          if [ "$IMAGE_TAG" = "pr-test" ]; then
            echo "tag=pr-test-${ARCH}" >> $GITHUB_OUTPUT
            echo "load_from_artifact=true" >> $GITHUB_OUTPUT
          else
            echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
            echo "load_from_artifact=false" >> $GITHUB_OUTPUT
          fi

      - name: Download Docker image artifact
        if: steps.image.outputs.load_from_artifact == 'true'
        uses: actions/download-artifact@v7
        with:
          name: docker-image-${{ steps.image.outputs.tag == 'pr-test-amd64' && 'amd64' || 'arm64' }}
          path: /tmp

      - name: Load Docker image from artifact
        if: steps.image.outputs.load_from_artifact == 'true'
        run: |
          gunzip -c /tmp/image-*.tar.gz | docker load

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.image.outputs.load_from_artifact == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Pull Docker Image from registry
        if: steps.image.outputs.load_from_artifact == 'false'
        run: docker pull --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }}

      - name: Create Output Directory
        run: mkdir -p test/output

      - name: Terragrunt Plan
        working-directory: test
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            --user $(id -u):$(id -g) \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }} \
            terragrunt plan

  combine-artifacts:
    name: Combine Test Artifacts
    runs-on: ubuntu-24.04
    needs:
      - test-terraform-workflow
      - test-linting
      - test-security
      - test-documentation
    if: always()
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v7
        with:
          path: /tmp/test-results
          pattern: "{terraform-plan,tflint-results,security-scan-results,terraform-docs}-*"
          merge-multiple: false

      - name: Organize Artifacts
        run: |
          mkdir -p /tmp/combined-results/{terraform-plans,linting,security,docs}

          # Move terraform plans
          if [ -d "/tmp/test-results/terraform-plan-linux-amd64" ]; then
            cp -r /tmp/test-results/terraform-plan-linux-amd64/* /tmp/combined-results/terraform-plans/ 2>/dev/null || true
          fi
          if [ -d "/tmp/test-results/terraform-plan-linux-arm64" ]; then
            cp -r /tmp/test-results/terraform-plan-linux-arm64/* /tmp/combined-results/terraform-plans/ 2>/dev/null || true
          fi

          # Move linting results
          if [ -d "/tmp/test-results/tflint-results-linux-amd64" ]; then
            cp -r /tmp/test-results/tflint-results-linux-amd64/* /tmp/combined-results/linting/ 2>/dev/null || true
          fi
          if [ -d "/tmp/test-results/tflint-results-linux-arm64" ]; then
            cp -r /tmp/test-results/tflint-results-linux-arm64/* /tmp/combined-results/linting/ 2>/dev/null || true
          fi

          # Move security scan results
          if [ -d "/tmp/test-results/security-scan-results-linux-amd64" ]; then
            cp -r /tmp/test-results/security-scan-results-linux-amd64/* /tmp/combined-results/security/ 2>/dev/null || true
          fi
          if [ -d "/tmp/test-results/security-scan-results-linux-arm64" ]; then
            cp -r /tmp/test-results/security-scan-results-linux-arm64/* /tmp/combined-results/security/ 2>/dev/null || true
          fi

          # Move documentation
          if [ -d "/tmp/test-results/terraform-docs-linux-amd64" ]; then
            cp -r /tmp/test-results/terraform-docs-linux-amd64/* /tmp/combined-results/docs/ 2>/dev/null || true
          fi
          if [ -d "/tmp/test-results/terraform-docs-linux-arm64" ]; then
            cp -r /tmp/test-results/terraform-docs-linux-arm64/* /tmp/combined-results/docs/ 2>/dev/null || true
          fi

      - name: Upload Combined Test Results
        uses: actions/upload-artifact@v6
        with:
          name: test-results-all-platforms
          path: /tmp/combined-results/
          retention-days: 7

  summary:
    name: Test Summary
    runs-on: ubuntu-24.04
    needs:
      - test-versions
      - test-terraform-workflow
      - test-linting
      - test-security
      - test-documentation
      - test-terragrunt
      - combine-artifacts
    if: always()
    steps:
      - name: Check Test Results
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tool Versions | ${{ needs.test-versions.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Workflow | ${{ needs.test-terraform-workflow.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linting Tools | ${{ needs.test-linting.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scanning | ${{ needs.test-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.test-documentation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terragrunt | ${{ needs.test-terragrunt.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Determine Overall Status
        run: |
          if [ "${{ needs.test-versions.result }}" != "success" ] || \
             [ "${{ needs.test-terraform-workflow.result }}" != "success" ] || \
             [ "${{ needs.test-linting.result }}" != "success" ] || \
             [ "${{ needs.test-security.result }}" != "success" ] || \
             [ "${{ needs.test-documentation.result }}" != "success" ] || \
             [ "${{ needs.test-terragrunt.result }}" != "success" ]; then
            echo "❌ Some tests failed"
            exit 1
          else
            echo "✅ All tests passed"
          fi
